---
title: 初探智能家居Home Assistant
layout: post
categories:
- Technique
tags:
- Raspberry Pi
- Home-assistant
- Homebridge
- Homekit
---

## 0. 起因

为什么要弄智能家居呢？来源于一个非常小的需求：家里的门锁总感觉不可靠，即使有了淘宝神器也不能完全安心，每天还是会纠结门是否关好。聊天的时候淡淡说有那种门窗传感器可以了解一下，于是乎上张大妈搜了一下，找到了一个讲小米智能家居全家桶排雷的文章，里面介绍到了Home Assistant开源智能家居平台，可以和苹果的Homekit进行对接，这样就可以在手机上监控家中的情况。这篇文章让我想起了国庆去托马斯家住的时候，早上七点钟灯会自动开起来，当时托马斯很自豪地说这是他设置的智能家居程式，让我羡慕不已，感觉有种赛博朋克的味道！正好，在实验室里面找到了闲置许久的树莓派，拿来做家庭控制中心正好不过了！

那么，这么多智能家居平台，要选择哪一家呢？说到智能家居，每个公司都有自己的战略布局，有小米博联这样的“半开放”平台（虽然加塞了自己的东西但是可以很好地接入第三方平台）和阿里京东这样的“封闭”平台（截止目前，天猫精灵AI联盟里面买的东西还是只能用天猫精灵控制，也就是从自家的app里面添加以外别无他法）。其实我们最经常能接触到的智能家居控制中心便是苹果的Homekit，界面非常符合苹果一贯的简洁风格，但是Homekit的配件都很贵，预算有限的人（包括我）常常会望而却步，才不得不考虑买其他家的智能家居产品。

如果不介意都买一家公司的“全家桶”，那么这家公司自己的智能家庭APP已经可以满足你的需求。如果考虑到价格和性能，每种产品都选择了不同家的公司，那手机里装的APP就要塞不下了。因此，最好的将他们整合在一起的方法便是第三方的开源平台。首先要说开源的Homebridge，由前Homekit程序员创建，用nodejs编写，让无法接入homekit的第三方产品通过插件兼容桥接入。还有其他一些好平台，比如Domoticz，openHAB等元老，笔者尚未接触过。根据网路上的描述，OpenHAB基于Java开发，社区非常成熟，而Domoticz用c++实现，体积小可扩展性高，但其中文社区不够活跃，文档也相对较少。接下来重点介绍Home Assistant（HA，下同）！HA属于新兴力量，基于Python且UI友好，崇尚“Simplicity”，社区活跃而文档丰富，每周都有新版本的小插件发布，比起审核严格的OpenHAB来说快不少。所以，最后综合考虑，我选择了HA作为控制中心，先来上一张效果图吧～对UI没有强迫症的我用的都是默认的UI设置。

![]({{ site.baseurl }}/public/images/HA1.png)

虽然智能家居其实和人工智能的“智能”二字相去甚远，但说到底本意是为了方便生活中的一些小细节，因此也算是一个很有意义的“大人的玩具”了～

## 1. 前置条件

### 1.1 硬件选择

任何电脑都可以运行HA：笔记本、台式机、Mac、微型电脑...等等。选择树莓派的原因是自己刚好就有一块，而且放在那里常开功率也不会太大，不会进入睡眠模式。虽然亲测初代B版树莓派也是可以满足需求的，但是在编译安装HA和其他插件的过程中总会出现这样那样的错误，和内存与算力均有关系。考虑到未来会加入摄像头（ffmpeg），或者希望自带WiFi（可以放在任何角落而不需要放在路由器旁边），树莓派三代B+版本是最好的选择。

### 1.2 操作系统及安装

任何操作系统都可以！因为HA是基于Python的，所以简单给出命令：

```zsh
$ sudo pip3 install homeassistant
```

即可。随后运行
```zsh
$ sudo 	hass --open-ui
``` 

来以root权限运行HA，目的是为了安装一些必要的插件。等到安装好以后就可以以普通用户身份运行HA了！

如果是在树莓派上，还可以考虑官方的[Hass.io](https://www.home-assistant.io/hassio/)，一个基于Docker的HA系统，将镜像烧录到SD卡上就可以即插即用！笔者不考虑Hass.io的原因是希望在树莓派上还可以运行一些别的程序，比如Homebridge或者媒体中心之类的，因此就选择了手动安装啦～

## 2. 配置

## 3. 设备

## 4. 自动化

## 5. 优化

有时候，传感器的数值在某个时间会突然跳动很厉害，造成某些自动化的误触发（比如上述的空气质量差时自动打开空净），这时候就要使用一些方法来去掉这些outliers，或者通过滤波来让数据更加平滑。

![]({{ site.baseurl }}/public/images/HA2.png)